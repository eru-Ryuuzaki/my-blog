---
theme: channing-cyan
---
> 本文参考自[浏览器工作原理与实践](https://time.geekbang.org/column/article/113513)

## 浏览器渲染流程

>按照渲染的时间顺序，可分为如下几个子阶段：**构建 DOM 树、样式计算、布局阶段、分层、绘制、分块、光栅化和合成**。

每个阶段的过程中，应该重点关注以下三点内容：
- 开始每个子阶段都有其输入的内容。
- 然后每个子阶段有其处理过程。
- 最终每个子阶段会生成输出内容。

### 构建 DOM 树

+ 输入内容：HTML 文件
+ 处理过程：由 HTML 解析器解析
+ 最终输出树状结构的 DOM 

#### DOM 和 HTML 内容几乎是一样的，但是**和 HTML 不同的是，DOM 是保存在内存中树状结构，可以通过 JavaScript 来查询或修改其内容**。（联想一下程序和进程之间的关系）

### 样式计算

#### CSS 加载不会阻塞 DOM 树解析，但会阻塞 DOM 树渲染。 所以为了避免用户看到长时间的白屏，应该尽快提高 CSS 的加载速度。 
-   使用CDN(因为CDN会根据你的网络状况，替你挑选最近的一个具有缓存内容的节点为你提供资源，因此可以减少加载时间)
-   对css进行压缩(可以用很多打包工具，比如webpack,gulp等，也可以通过开启gzip压缩)
-   合理的使用缓存(设置cache-control,expires,以及E-tag都是不错的，不过要注意一个问题，就是文件更新后，你要避免缓存而带来的影响。其中一个解决防范是在文件名字后面加一个版本号)
-   减少http请求数，将多个css文件合并，或者是干脆直接写成内联样式(内联样式的一个缺点就是不能缓存)

#### DOM 解析和 CSS 解析是两个并行的过程，所以这也解释了为什么 CSS 加载不会阻塞 DOM 解析。但是因为 render tree 依赖于 DOM 树和 cssom 树，所以必须等到 cssom 树构建完成，也就是 CSS 资源加载完成。

### 进程和线程
#### 一、进程与线程的关系

1. 线程是依附于进程的，而进程中使用多线程并行处理能提升运算效率。 
2. 进程中的任意一线程执行出错，都会导致整个进程的崩溃。**所以js（线程）执行报错时导致整个渲染进程停止工作**
3. 线程之间共享进程中的数据。 
4. 当一个进程关闭之后，操作系统会回收进程所占用的内存。当一个进程退出时，操作系统会回收该进程所申请的所有资源；即使其中任意线程因为操作不当导致内存泄漏，当进程退出时，这些内存也会被正确回收。 
5. 进程之间的内容相互隔离。进程隔离是为保护操作系统中进程互不干扰的技术，每一个进程只能访问自己占有的数据，也就避免出现进程 A 写入数据到进程 B 的情况。正是因为进程之间的数据是严格隔离的，所以一个进程如果崩溃了，或者挂起了，是不会影响到其他进程的。如果进程之间需要进行数据的通信，这时候，就需要使用用于进程间通信（IPC）的机制了

#### 二、进程与线程的区别

1. 进程是资源分配的最小单位，线程是程序执行的最小单位（资源调度的最小单位）。
2. 进程有自己的独立地址空间，每启动一个进程，系统就会为它分配地址空间，建立数据表来维护代码段、堆栈段和数据段，这种操作非常昂贵。而线程是共享进程中的数据的，使用相同的地址空间，因此CPU切换一个线程的花费远比进程要小很多，同时创建一个线程的开销也比进程要小很多。
3. 线程之间的通信更方便，同一进程下的线程共享全局变量、静态变量等数据，而进程之间的通信需要以通信的方式（IPC)进行。不过如何处理好同步与互斥是编写多线程程序的难点。
4. 但是多进程程序更健壮，多线程程序只要有一个线程死掉，整个进程也死掉了，而一个进程死掉并不会对另外一个进程造成影响，因为进程有自己独立的地址空间。

### 查看 Chorme 浏览器进程信息

点击 Chrome 浏览器右上角的“选项”菜单，选择“更多工具”子菜单，点击“任务管理器”，这将打开 Chrome 的任务管理器的窗口

### 首屏时间可以考虑的优化方向

首屏的显示就涉及了 DNS、HTTP、DOM 解析、CSS 阻塞、JavaScript 阻塞等技术因素，其中一项没处理好就可能导致整个页面的延时。

### 同源策略

> 同源策略（Same origin policy）是一种约定，它是浏览器最核心也最基本的安全功能，如果缺少了同源策略，则浏览器的正常功能可能都会受到影响。可以说 Web 是构建在同源策略基础之上的，浏览器只是针对同源策略的一种实现。
>
> 它的核心就在于它认为自任何站点装载的信赖内容是不安全的。当被浏览器半信半疑的脚本运行在沙箱时，它们应该只被允许访问来自同一站点的资源，而不是那些来自其它站点可能怀有恶意的资源。
>
> 所谓同源是指：域名、协议、端口相同。

#### 跨域

+ jsonp
  + 只支持 get 方法